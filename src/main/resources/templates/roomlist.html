<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://use.fontawesome.com/releases/v5.1.0/css/all.css"
        integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
        crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
          integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
          crossorigin="anonymous"></script>
  <script src="/js/password_bootstrap.js"></script>
  <script th:inline="javascript">
    var roomId;

    $(function(){
      let maxChk = $("#maxChk");
      let maxUserCnt = $("#maxUserCnt");

      //ì±„íŒ…ë°© ì…ì¥ ëª¨ë‹¬
      $("#enterRoomModal").on("show.bs.modal", function (event) {
        roomId = $(event.relatedTarget).data('id');
      });

      //ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬
      $("#confirmPwdModal").on("show.bs.modal", function (e) {
        roomId = $(e.relatedTarget).data('id');
      });

      // ì±„íŒ…ë°© ì„¤ì • ì‹œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      $("#confirmPwd").on("keyup", function(){
        let confirmPwd = $("#confirmPwd").val();
        const configRoomBtn = $("#configRoomBtn");
        let confirmLabel = $("#confirmLabel");

        $.ajax({
          type : "post",
          url : "/chat/confirmPwd/"+roomId,
          data : {
            "roomPwd" : confirmPwd
          },
          success : function(result){
            if(result){
              configRoomBtn.attr("class", "btn btn-primary");
              configRoomBtn.attr("aria-disabled", false);

              confirmLabel.html("<span id='confirm'>ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ</span>");
              $("#confirm").css({
                "color" : "#0D6EFD",
                "font-weight" : "bold",
              });

            }else{
              configRoomBtn.attr("class", "btn btn-primary disabled");
              configRoomBtn.attr("aria-disabled", true);

              confirmLabel.html("<span id='confirm'>ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤</span>");
              $("#confirm").css({
                "color" : "#FA3E3E",
                "font-weight" : "bold",
              });
            }
          }
        })
      })

      // ê¸°ë³¸ì€ ìœ ì € ì„¤ì • ì¹¸ ë¯¸í™œì„±í™”
      maxUserCnt.hide();

      // ì²´í¬ë°•ìŠ¤ ì²´í¬ì— ë”°ë¼ ì¸ì› ì„¤ì •ì¹¸ í™œì„±í™” ì—¬ë¶€
      maxChk.change(function(){
        if(maxChk.is(':checked')){
          maxUserCnt.val('');
          maxUserCnt.show();
        }else{
          maxUserCnt.hide();
        }
      })
    })

    function createRoom(){
      let name = $("#roomName").val();
      let pwd = $("#roomPwd").val();
      let secret = $("#secret").is(':checked');
      let secretChk = $("#secretChk");
      let maxUserCnt = $("#maxUserCnt");

      if(name === ""){
        alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return false;
      }

      if (secret) {
        secretChk.attr('value', true);
      } else {
        secretChk.attr('value', false);
      }

      if (pwd === "") {
        alert("ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        return false;
      }

      // ìµœì†Œ ë°© ì¸ì› ìˆ˜
      if(maxUserCnt.val() <= 1){
        alert("í˜¼ìì„œëŠ” ì±„íŒ…ì´ ë¶ˆê°€ëŠ¥í•´ìš”");
        return false;
      }

      if ($("#" + name).length > 0){
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°©ì…ë‹ˆë‹¤")
        return false;
      }

      return true;
    }

    function enterRoom(){
      let enterPwd = $("#enterPwd").val();

      $.ajax({
        type : "post",
        url : "/chat/confirmPwd/"+roomId,
        async : false,
        data : {
          "roomPwd" : enterPwd
        },
        success : function(result){
          if(result){
            if (chkRoomUserCnt(roomId)) {
              location.href = "/chat/room?roomId="+roomId;
            }
          }else{
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤. \n ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”")
          }
        }
      })
    }

    // ì±„íŒ…ë°© ì‚­ì œ
    function delRoom(){
      location.href = "/chat/delRoom/"+roomId;
    }

    // ì±„íŒ…ë°© ì…ì¥ ì‹œ ì¸ì› ìˆ˜ì— ë”°ë¼ì„œ ì…ì¥ ì—¬ë¶€ ê²°ì •
    function chkRoomUserCnt(roomId){
      let chk;

      $.ajax({
        type : "GET",
        url : "/chat/chkUserCnt/"+roomId,
        async : false,
        success : function(result){
          if (!result) {
            alert("ì±„íŒ…ë°©ì´ ê½‰ ì°¨ì„œ ì…ì¥ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          }
          chk = result;
        }
      })

      return chk;
    }
  </script>

  <style>
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ */
      align-items: center;     /* ì„¸ë¡œ ì¤‘ì•™ */
      background-color: #f8f9fa;
      font-size: 1.1rem;
    }

    .container {
      max-width: 1200px;   /* ë” í¬ê²Œ */
      width: 80%;          /* í™”ë©´ ë„“ì´ì˜ 80% */
      min-width: 600px;    /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ìµœì†Œ í¬ê¸° ì„¤ì • */
      padding: 40px;       /* íŒ¨ë”©ë„ ëŠ˜ë¦¼ */
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
    }

    .btn-info {
      font-size: 1.1rem;
      padding: 0.6rem 1.2rem;
      margin-top: 0; /* í…Œì´ë¸” ë§ˆì§„ìœ¼ë¡œ í•´ê²°í–ˆìœ¼ë‹ˆ ë²„íŠ¼ ë§ˆì§„ì€ 0 */
    }

    a {
      text-decoration: none;
    }
    #table{
      margin-top: 40px;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    h2{
      margin-top: 40px;
    }

    input#maxUserCnt {
      width: 160px;
    }

    span.input-group-text.input-password-hide {
      height: 40px;
    }

    span.input-group-text.input-password-show {
      height: 40px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸</h2>
    <div th:if="${username == null}" class="row">
      <div class="col">
        <a href="/chatlogin"><button type="button" class="btn btn-primary">ë¡œê·¸ì¸</button></a>
        <a href="/signup"><button type="button" class="btn btn-primary">íšŒì›ê°€ì…</button></a>
      </div>
    </div>
    <h5 th:if="${username != null}">
      [[${userName}]]
    </h5>
    <table class="table table-hover" id="table">
      <thead>
      <tr>
        <th scope="col">ì±„íŒ…ë°©ëª…</th>
        <th scope="col">ì ê¸ˆ ì—¬ë¶€</th>
        <th scope="col">ì°¸ì—¬ ì¸ì›</th>
        <th scope="col">ì±„íŒ…ë°© ì„¤ì •</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="room : ${list}">
        <td>
          <a th:if="${room.secretChk}" href="#enterRoomModal" data-bs-toggle="modal"
             th:data-id="${room.roomId}">[[${room.roomName}]]</a>
          <a th:if="${!room.secretChk}" th:href="@{/chat/room(roomId=${room.roomId})}" th:roomId="${room.roomId}" onclick="return chkRoomUserCnt(this.getAttribute('roomId'))">[[${room.roomName}]]</a>
        </td>
        <td>
          <span th:if="${room.secretChk}">ğŸ”’ï¸</span>
        </td>
        <td>
          <span class="badge bg-primary rounded-pill">[[${room.userCount}]]/[[${room.maxUserCnt}]]</span>
        </td>
        <td>
          <button class="btn btn-primary btn-sm"
                  th:id="'configRoom_' + ${room.roomId}"
                  data-bs-toggle="modal" data-bs-target="#confirmPwdModal"
                  th:data-id="${room.roomId}">ì±„íŒ…ë°© ì„¤ì •</button>
        </td>
      </tr>
      </tbody>
    </table>
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#roomModal">ë°© ìƒì„±</button>
  </div>

  <!-- ë°© ìƒì„± ëª¨ë‹¬ -->
  <div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì±„íŒ…ë°© ìƒì„±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="/chat/createroom" onsubmit="return createRoom()">
          <div class="modal-body">
            <div class="mb-3">
              <label for="roomName" class="col-form-label">ë°© ì´ë¦„</label>
              <input type="text" class="form-control" id="roomName" name="roomName">
            </div>
            <div class="mb-3">
              <label for="roomPwd" class="col-form-label">ë°© ì„¤ì • ë²ˆí˜¸(ë°© ì‚­ì œì‹œ í•„ìš”)</label>
              <div class="input-group">
                <input type="password" name="roomPwd" id="roomPwd" class="form-control" data-toggle="password">
                <div class="input-group-append">
                  <span class="input-group-text"><i class="fa fa-eye"></i></span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="maxUserCnt" class="col-form-label">ì±„íŒ…ë°© ì¸ì› ì„¤ì •(ë¯¸ì²´í¬ ì‹œ ê¸°ë³¸ 100ëª…)
                <input class="form-check-input" type="checkbox" id="maxChk"></label>
              <input type="text" class="form-control" id="maxUserCnt" name="maxUserCnt" value="100">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="secret">
              <input type="hidden" name="secretChk" id="secretChk" value="">
              <label class="form-check-label" for="secret">ì±„íŒ…ë°© ì ê¸ˆ</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <input type="submit" class="btn btn-primary" value="ë°© ìƒì„±í•˜ê¸°">
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ë°© ì…ì¥ ëª¨ë‹¬ -->
  <div class="modal fade" id="enterRoomModal" tabindex="-1" aria-labelledby="enterRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì±„íŒ…ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="enterPwd" class="col-form-label">ë°© ë¹„ë°€ë²ˆí˜¸</label>
            <input type="text" class="form-control" id="enterPwd" name="enterPwd">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«</button>
          <button type="button" class="btn btn-primary" onclick="enterRoom()">ì…ì¥í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬ -->
  <div class="modal fade" id="confirmPwdModal" tabindex="-1" aria-labelledby="ModalToggleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì±„íŒ…ë°© ì„¤ì •ì„ ìœ„í•œ íŒ¨ìŠ¤ì›Œë“œ í™•ì¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="confirmPwd" class="col-form-label" id="confirmLabel">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input type="text" class="form-control" id="confirmPwd">
        </div>
        <div class="modal-footer">
          <button id="configRoomBtn" class="btn btn-primary disabled" data-bs-target="#configRoomModal" data-bs-toggle="modal" aria-disabled="true">ì±„íŒ…ë°© ì„¤ì •í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ…ë°© ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="configRoomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì±„íŒ…ë°© ì„¤ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="chPwd" class="col-form-label">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
            <input type="text" class="form-control" id="chPwd" name="roomName">
          </div>
          <div class="mb-3">
            <label for="chRoomName" class="col-form-label">ì±„íŒ…ë°© ì´ë¦„ ë³€ê²½</label>
            <input type="text" class="form-control" id="chRoomName" name="roomPwd">
          </div>
          <div class="mb-3">
            <label for="chRoomUserCnt" class="col-form-label">ì±„íŒ…ë°© ì¸ì› ë³€ê²½</label>
            <input type="text" class="form-control" id="chRoomUserCnt" name="roomPwd">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chSecret">
            <input type="hidden" name="secretChk" id="chSecretChk" value="">
            <label class="form-check-label" for="secret">
              ì±„íŒ…ë°© ì ê¸ˆ
            </label>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-primary" onclick="delRoom()">ë°© ì‚­ì œ</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="">ë³€ê²½</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>